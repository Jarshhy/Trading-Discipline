<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>2026 Beast Dashboard</title>
  <style>
    :root{
      --bg:#0b0c14; --panel:#14162a; --text:#e8eaf3; --muted:rgba(232,234,243,.7);
      --line:rgba(255,255,255,.10); --purple:#7b6cff; --accent:#f6c56b;
      --green:#4ade80; --red:#fb7185; --blue:#60a5fa;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:radial-gradient(1200px 600px at 20% 0%, rgba(123,108,255,.22), transparent 55%),
                 radial-gradient(900px 500px at 80% 0%, rgba(246,197,107,.16), transparent 60%),
                 var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(135deg, rgba(30,27,75,.85), rgba(17,24,39,.55));
    }
    h1{margin:0;font-size:16px;letter-spacing:.2px}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .card{
      background:linear-gradient(180deg, rgba(20,22,42,.95), rgba(12,14,28,.95));
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      margin-bottom:12px;
    }
    .kpis{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(170px,1fr));
      gap:10px;
    }
    .kpi{
      background:rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      text-align:center;
    }
    .kpi b{font-size:18px}
    .small{font-size:12px;color:var(--muted);line-height:1.35}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      font-size:12px;color:var(--muted);
      margin:4px 6px 0 0;
    }
    .pill strong{color:var(--text)}
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:12px;
    }
    .titleRow{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
    .h2{font-size:13px;margin:0;color:rgba(232,234,243,.95);letter-spacing:.2px}
    .xpbar{
      height:10px;border-radius:999px;overflow:hidden;
      background:rgba(255,255,255,.08);
      border:1px solid var(--line);
      margin-top:8px;
    }
    .xpfill{
      height:100%; width:0%;
      background:linear-gradient(90deg,var(--purple),var(--accent));
      transition:width .35s ease;
    }
    .row{display:flex;justify-content:space-between;gap:10px;margin-top:8px}
    .btnRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    button{
      border:none;border-radius:10px;padding:8px 10px;
      cursor:pointer;font-weight:800;
      background:var(--accent);color:#101012;
    }
    button.secondary{background:rgba(255,255,255,.08);color:var(--text);border:1px solid var(--line)}
    button.danger{background:rgba(251,113,133,.95);color:#0b0c14}
    button:disabled{opacity:.55;cursor:not-allowed}
    hr{border:none;border-top:1px solid var(--line);margin:12px 0}
    .warn{color:rgba(251,113,133,.95);font-weight:800}
    .ok{color:rgba(74,222,128,.95);font-weight:800}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    .tabs{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .tab{
      padding:8px 10px;border-radius:10px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      cursor:pointer; user-select:none;
      font-size:13px;
    }
    .tab.active{background:rgba(123,108,255,.18); border-color:rgba(123,108,255,.35)}
    .tabcontent{display:none}
    .tabcontent.active{display:block}
    input, select, textarea{
      width:100%;
      padding:10px;border-radius:10px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      font-size:13px;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius:12px;
      background:rgba(255,255,255,.02);
    }
    th,td{
      padding:10px;
      border-bottom:1px solid var(--line);
      font-size:13px;
      text-align:left;
    }
    th{background:rgba(255,255,255,.03); color:rgba(232,234,243,.9)}
    tr:last-child td{border-bottom:none}
    .twoCol{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    canvas{width:100%;height:260px;border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.02)}
    .overlayLock{
      border:1px solid rgba(251,113,133,.35);
      background:rgba(251,113,133,.08);
      padding:10px;
      border-radius:12px;
      margin-top:10px;
    }
  </style>
</head>
<body>
<header>
  <h1>2026 Beast Dashboard ‚Äî 4 Pillars + Rank Gate + Trading Discipline Board</h1>
</header>

<div class="wrap">

  <!-- GLOBAL HEADER -->
  <div class="card">
    <div class="kpis">
      <div class="kpi">Overall Rank<br><b id="overallRank">1</b><div class="small" id="rankGateText"></div></div>
      <div class="kpi">Trader Level<br><b id="lvlTrader">1</b><div class="small" id="xpTraderText"></div></div>
      <div class="kpi">Body Level<br><b id="lvlBody">1</b><div class="small" id="xpBodyText"></div></div>
      <div class="kpi">Closer Level<br><b id="lvlCloser">1</b><div class="small" id="xpCloserText"></div></div>
      <div class="kpi">Family Level<br><b id="lvlFamily">1</b><div class="small" id="xpFamilyText"></div></div>
    </div>

    <div style="margin-top:10px">
      <span class="pill" id="pillTradeToday"><strong>Trading Today:</strong> Unknown</span>
      <span class="pill" id="pillTradeNext"><strong>Trading Next Day:</strong> Unknown</span>
      <span class="pill" id="pillDD"><strong>Apex DD Rule:</strong> Stop &lt; $2,000 buffer</span>
      <span class="pill" id="pillHabit"><strong>Habit Rule:</strong> If YES ‚Üí No Trading (today/next)</span>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="pillars">Pillars</div>
      <div class="tab" data-tab="trading">Trading Board</div>
      <div class="tab" data-tab="backup">Backup</div>
    </div>
  </div>

  <!-- PILLARS TAB -->
  <div id="pillars" class="tabcontent active">
    <div class="grid">

      <div class="card">
        <div class="titleRow">
          <div class="h2">üß† Trader</div>
          <span class="pill"><strong>Today XP:</strong> <span id="todayTrader">0</span></span>
        </div>
        <div class="small">Trader XP freezes if trading is halted (burn rule).</div>
        <div class="xpbar"><div class="xpfill" id="barTrader"></div></div>
        <div class="row small">
          <div>Level: <b id="cardLvlTrader">1</b></div>
          <div>XP: <b id="cardXpTrader">0</b> / <b id="needTrader">100</b></div>
        </div>
        <hr/>
        <div class="btnRow">
          <button onclick="addXP('trader',50)">All Apex rules followed (+50)</button>
          <button onclick="addXP('trader',40)">Stopped at DD buffer (+40)</button>
          <button onclick="addXP('trader',20)">Journal complete (+20)</button>
          <button class="danger" onclick="addXP('trader',-100)">Size-up after red (-100)</button>
        </div>
        <div class="small" id="traderLockText"></div>

        <hr/>
        <div class="btnRow">
          <button class="danger" onclick="markHabitYesNow()">Habit = YES (halts trading)</button>
          <button class="secondary" onclick="markHabitNo()">Habit = NO (today)</button>
          <button class="secondary" onclick="toggleTradeHaltToday()">Toggle: Trading Halted Today</button>
          <button class="secondary" onclick="toggleTradeHaltNext()">Toggle: Trading Halted Next Day</button>
        </div>
        <div class="small" style="margin-top:8px">
          If habit occurs <b>after</b> trading: press Habit YES, then toggle ‚ÄúHalted Next Day‚Äù.
          (We‚Äôll automate this in the next step.)
        </div>
      </div>

      <div class="card">
        <div class="titleRow">
          <div class="h2">üí™ Body</div>
          <span class="pill"><strong>Today XP:</strong> <span id="todayBody">0</span></span>
        </div>
        <div class="xpbar"><div class="xpfill" id="barBody"></div></div>
        <div class="row small">
          <div>Level: <b id="cardLvlBody">1</b></div>
          <div>XP: <b id="cardXpBody">0</b> / <b id="needBody">100</b></div>
        </div>
        <hr/>
        <div class="btnRow">
          <button onclick="addXP('body',25)">Cold plunge (+25)</button>
          <button onclick="addXP('body',40)">Lift (+40)</button>
          <button onclick="addXP('body',30)">Diet compliant (+30)</button>
          <button onclick="addXP('body',25)">In bed by cutoff (+25)</button>
          <button onclick="addXP('body',50)">Habit avoided (+50)</button>
        </div>
      </div>

      <div class="card">
        <div class="titleRow">
          <div class="h2">üíº Closer</div>
          <span class="pill"><strong>Today XP:</strong> <span id="todayCloser">0</span></span>
        </div>
        <div class="xpbar"><div class="xpfill" id="barCloser"></div></div>
        <div class="row small">
          <div>Level: <b id="cardLvlCloser">1</b></div>
          <div>XP: <b id="cardXpCloser">0</b> / <b id="needCloser">100</b></div>
        </div>
        <hr/>
        <div class="btnRow">
          <button onclick="addXP('closer',50)">2h dialing (+50)</button>
          <button onclick="addXP('closer',20)">CRM + follow-ups (+20)</button>
          <button onclick="addXP('closer',25)">Deal closed (+25)</button>
          <button onclick="addXP('closer',15)">Self-sourced bonus (+15)</button>
          <button onclick="addXP('closer',15)">No-trial bonus (+15)</button>
        </div>
      </div>

      <div class="card">
        <div class="titleRow">
          <div class="h2">‚ù§Ô∏è Husband / Father</div>
          <span class="pill"><strong>Today XP:</strong> <span id="todayFamily">0</span></span>
        </div>
        <div class="xpbar"><div class="xpfill" id="barFamily"></div></div>
        <div class="row small">
          <div>Level: <b id="cardLvlFamily">1</b></div>
          <div>XP: <b id="cardXpFamily">0</b> / <b id="needFamily">100</b></div>
        </div>
        <hr/>
        <div class="btnRow">
          <button onclick="addXP('family',40)">Spouse time (no phone) (+40)</button>
          <button onclick="addXP('family',30)">Kid time engaged (+30)</button>
          <button onclick="addXP('family',20)">Helped unasked (+20)</button>
          <button onclick="addXP('family',20)">Calm under stress (+20)</button>
          <button onclick="addXP('family',100)">Weekly date/leadership (+100)</button>
        </div>
      </div>

    </div>
  </div>

  <!-- TRADING BOARD TAB -->
  <div id="trading" class="tabcontent">
    <div class="card">
      <div class="titleRow">
        <div class="h2">üìä Trading Board (Aggregate Daily)</div>
        <span class="pill"><strong>Equity:</strong> $<span id="equityNow">0</span></span>
      </div>
      <div class="small">
        Log only meaningful stats from Tradovate. No account names. No fluff.
      </div>

      <div id="lockOverlay" class="overlayLock" style="display:none;">
        <div class="warn">TRADING HALTED ‚Äî NO MARKET INTERACTION</div>
        <div class="small">This is training. Losing access is the consequence. Trader XP is frozen today.</div>
      </div>

      <hr/>

      <div class="twoCol">
        <div class="card" style="margin:0;background:rgba(255,255,255,.02)">
          <h1 style="font-size:14px;margin:0 0 8px 0">Add Daily Log</h1>
          <div class="small">Date auto-fills. Enter daily totals from Tradovate.</div>

          <div style="margin-top:10px" class="small">Net PnL ($)</div>
          <input id="inPnl" type="number" step="0.01" placeholder="e.g. 350.25" />

          <div style="margin-top:10px" class="small">Trades</div>
          <input id="inTrades" type="number" min="0" placeholder="e.g. 6" />

          <div style="margin-top:10px" class="small">Wins</div>
          <input id="inWins" type="number" min="0" placeholder="e.g. 4" />

          <div style="margin-top:10px" class="small">Losses</div>
          <input id="inLosses" type="number" min="0" placeholder="e.g. 2" />

          <div style="margin-top:10px" class="small">Rule Violations (0 if clean)</div>
          <input id="inVios" type="number" min="0" placeholder="e.g. 0" />

          <div style="margin-top:10px" class="small">DD Buffer ($) (optional)</div>
          <input id="inDdBuf" type="number" step="0.01" placeholder="e.g. 4200 (leave blank if unknown)" />

          <div class="btnRow">
            <button onclick="saveDailyLog()">Save Day</button>
            <button class="secondary" onclick="deleteTodayLog()">Delete Today</button>
          </div>

          <div class="small" style="margin-top:8px">
            Trader XP auto-award (only if trading not halted):
            <ul style="margin:6px 0 0 18px;padding:0">
              <li>Clean day (violations = 0) ‚Üí +50 XP</li>
              <li>Violations &gt; 0 ‚Üí 0 XP and flags ‚Äúdiscipline hit‚Äù</li>
              <li>DD buffer &lt; 2000 ‚Üí trading halt today (visual)</li>
            </ul>
          </div>
        </div>

        <div class="card" style="margin:0;background:rgba(255,255,255,.02)">
          <h1 style="font-size:14px;margin:0 0 8px 0">Equity Curve</h1>
          <canvas id="equityChart" width="900" height="260"></canvas>
          <hr/>
          <div class="twoCol" style="gap:8px">
            <div class="pill"><strong>Win Rate:</strong> <span id="statWr">0%</span></div>
            <div class="pill"><strong>Avg Daily PnL:</strong> $<span id="statAvg">0</span></div>
            <div class="pill"><strong>Max Drawdown:</strong> $<span id="statMdd">0</span></div>
            <div class="pill"><strong>Days Logged:</strong> <span id="statDays">0</span></div>
          </div>
          <div class="small" style="margin-top:8px">
            These are daily-aggregate stats. We can upgrade to per-trade later if you ever want it.
          </div>
        </div>
      </div>

      <hr/>

      <h1 style="font-size:14px;margin:0 0 8px 0">Daily Logs</h1>
      <div class="small">Tap Save Day once per day. Editing is done by saving again (it overwrites today).</div>
      <div style="overflow:auto;margin-top:10px">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Net PnL</th>
              <th>Trades</th>
              <th>W</th>
              <th>L</th>
              <th>Violations</th>
              <th>DD Buffer</th>
            </tr>
          </thead>
          <tbody id="logTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- BACKUP TAB -->
  <div id="backup" class="tabcontent">
    <div class="card">
      <div class="h2">Backup / Restore</div>
      <div class="small">LocalStorage is phone-only. Use this to export and keep a copy.</div>
      <hr/>
      <div class="btnRow">
        <button onclick="exportData()">Export JSON</button>
        <button class="secondary" onclick="document.getElementById('importBox').focus()">Import JSON</button>
        <button class="danger" onclick="hardResetAll()">Hard Reset All</button>
      </div>
      <div style="margin-top:10px" class="small">Paste JSON here to restore:</div>
      <textarea id="importBox" rows="8" placeholder="Paste exported JSON here"></textarea>
      <div class="btnRow">
        <button class="secondary" onclick="importData()">Restore Now</button>
      </div>
      <div class="small" style="margin-top:8px">
        After export, email/text it to yourself or save in Notes/Drive.
      </div>
    </div>
  </div>

</div>

<script>
/* =======================
   DATA + RESET ENGINE
   ======================= */
const KEY = "beastDashboard_v2";

const todayKey = () => new Date().toDateString();

const defaults = {
  lastDate: null,
  pillars: {
    trader: { lvl: 1, xp: 0, todayXP: 0 },
    body:   { lvl: 1, xp: 0, todayXP: 0 },
    closer: { lvl: 1, xp: 0, todayXP: 0 },
    family: { lvl: 1, xp: 0, todayXP: 0 },
  },
  locks: {
    tradingHaltedToday: false,
    tradingHaltedNext: false,
    habitYesToday: false
  },
  trading: {
    dailyLogs: {
      // dateStr: { pnl, trades, wins, losses, vios, ddBuf }
    }
  }
};

let state = JSON.parse(localStorage.getItem(KEY)) || structuredClone(defaults);

function needForLevel(lvl){ return 100 * lvl; }

function resetIfNewDay(){
  const t = todayKey();
  if(state.lastDate !== t){
    state.locks.tradingHaltedToday = !!state.locks.tradingHaltedNext;
    state.locks.tradingHaltedNext = false;
    state.locks.habitYesToday = false;

    for(const k of Object.keys(state.pillars)){
      state.pillars[k].todayXP = 0;
    }

    state.lastDate = t;
    save();
  }
}

function save(){
  localStorage.setItem(KEY, JSON.stringify(state));
  render();
}

resetIfNewDay();

/* =======================
   XP + LEVELING
   ======================= */
function addXP(pillar, amount){
  resetIfNewDay();
  if(pillar === "trader" && state.locks.tradingHaltedToday){
    alert("Trader XP is frozen because trading is halted today.");
    return;
  }
  const p = state.pillars[pillar];
  p.xp += amount;
  p.todayXP += amount;
  if(p.xp < 0){ p.xp = 0; }

  while(p.xp >= needForLevel(p.lvl)){
    p.xp -= needForLevel(p.lvl);
    p.lvl += 1;
  }
  save();
}

/* =======================
   OVERALL RANK + GATES
   ======================= */
function avgLevel(){
  const lvls = Object.values(state.pillars).map(p=>p.lvl);
  return lvls.reduce((a,b)=>a+b,0) / lvls.length;
}

function minLevelRequiredForRank(rank){
  if(rank <= 5) return 1;
  if(rank <= 10) return 5;
  if(rank <= 15) return 10;
  if(rank <= 20) return 15;
  return 20;
}

function computeRank(){
  const raw = avgLevel();
  const targetRank = Math.floor(raw);
  const minReq = minLevelRequiredForRank(targetRank);

  const minPillarLvl = Math.min(
    state.pillars.trader.lvl,
    state.pillars.body.lvl,
    state.pillars.closer.lvl,
    state.pillars.family.lvl
  );

  if(minPillarLvl < minReq){
    let r = targetRank;
    while(r > 1 && minPillarLvl < minLevelRequiredForRank(r)){
      r--;
    }
    return { rank: Math.max(1,r), gated:true, minReq: minLevelRequiredForRank(targetRank), weakest:minPillarLvl, target:targetRank };
  }
  return { rank: Math.max(1,targetRank), gated:false, minReq, weakest:minPillarLvl, target:targetRank };
}

/* =======================
   LOCK / HABIT ACTIONS
   ======================= */
function markHabitYesNow(){
  resetIfNewDay();
  state.locks.habitYesToday = true;
  state.locks.tradingHaltedToday = true;
  save();
  alert("Habit marked YES. Trading halted today. If this occurred after trading, also toggle 'Halted Next Day'.");
}

function markHabitNo(){
  resetIfNewDay();
  state.locks.habitYesToday = false;
  save();
}

function toggleTradeHaltToday(){
  resetIfNewDay();
  state.locks.tradingHaltedToday = !state.locks.tradingHaltedToday;
  save();
}

function toggleTradeHaltNext(){
  resetIfNewDay();
  state.locks.tradingHaltedNext = !state.locks.tradingHaltedNext;
  save();
}

/* =======================
   TRADING DAILY LOGS (AGGREGATE)
   ======================= */
function saveDailyLog(){
  resetIfNewDay();
  const d = todayKey();

  const pnl = Number(document.getElementById("inPnl").value || 0);
  const trades = Number(document.getElementById("inTrades").value || 0);
  const wins = Number(document.getElementById("inWins").value || 0);
  const losses = Number(document.getElementById("inLosses").value || 0);
  const vios = Number(document.getElementById("inVios").value || 0);
  const ddRaw = document.getElementById("inDdBuf").value;
  const ddBuf = ddRaw === "" ? null : Number(ddRaw);

  state.trading.dailyLogs[d] = { pnl, trades, wins, losses, vios, ddBuf };

  // Apex DD rule visual enforcement: if buffer known and < 2000 ‚Üí halt today
  if(ddBuf !== null && ddBuf < 2000){
    state.locks.tradingHaltedToday = true;
  }

  // Auto Trader XP award: only if not halted and violations == 0
  // (one award per day; overwrite logic: if already awarded, we don't double-award)
  // We detect by storing a hidden field in the log.
  const log = state.trading.dailyLogs[d];
  if(!log.xpAwarded){
    if(!state.locks.tradingHaltedToday && vios === 0){
      addXP("trader", 50);
      log.xpAwarded = true;
    } else {
      log.xpAwarded = true; // mark processed; no XP
    }
  }

  save();
}

function deleteTodayLog(){
  resetIfNewDay();
  const d = todayKey();
  if(!state.trading.dailyLogs[d]) return;
  if(!confirm("Delete today's trading log?")) return;
  delete state.trading.dailyLogs[d];
  save();
}

/* =======================
   EQUITY + STATS + CHART
   ======================= */
function getSortedLogs(){
  const entries = Object.entries(state.trading.dailyLogs)
    .map(([date, v]) => ({ date, ...v }))
    .sort((a,b) => new Date(a.date) - new Date(b.date));
  return entries;
}

function fmtMoney(n){
  const sign = n < 0 ? "-" : "";
  const abs = Math.abs(n);
  return sign + abs.toLocaleString(undefined, {maximumFractionDigits:2});
}

function computeEquitySeries(logs){
  let eq = 0;
  const pts = logs.map(l => {
    eq += (Number(l.pnl)||0);
    return { x:l.date, y:eq };
  });
  return pts;
}

function computeStats(logs){
  if(logs.length === 0){
    return { equity:0, wr:0, avg:0, mdd:0, days:0 };
  }
  const equitySeries = computeEquitySeries(logs);
  const equity = equitySeries[equitySeries.length-1].y;

  let totalWins=0, totalTrades=0, sum=0;
  for(const l of logs){
    totalWins += Number(l.wins)||0;
    totalTrades += Number(l.trades)||0;
    sum += Number(l.pnl)||0;
  }
  const wr = totalTrades > 0 ? (totalWins/totalTrades) : 0;
  const avg = logs.length > 0 ? (sum/logs.length) : 0;

  // max drawdown on equity curve
  let peak = -Infinity;
  let mdd = 0;
  for(const p of equitySeries){
    if(p.y > peak) peak = p.y;
    const dd = peak - p.y;
    if(dd > mdd) mdd = dd;
  }
  return { equity, wr, avg, mdd, days:logs.length, equitySeries };
}

function drawChart(points){
  const canvas = document.getElementById("equityChart");
  const ctx = canvas.getContext("2d");

  // HiDPI fix (iPhone): match drawing buffer to CSS size
  const cssW = canvas.clientWidth || 900;
  const cssH = canvas.clientHeight || 260;
  const dpr = window.devicePixelRatio || 1;

  canvas.width = Math.floor(cssW * dpr);
  canvas.height = Math.floor(cssH * dpr);
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // draw in CSS pixels

  // Clear
  ctx.clearRect(0, 0, cssW, cssH);

  const padL = 42, padR = 14, padT = 14, padB = 34;

  // Empty state
  if(points.length === 0){
    ctx.fillStyle = "rgba(232,234,243,.7)";
    ctx.font = "14px system-ui";
    ctx.fillText("No data yet. Add your first daily log.", padL, cssH/2);
    return;
  }

  const ys = points.map(p=>p.y);
  const minY = Math.min(...ys);
  const maxY = Math.max(...ys);
  const rangeY = (maxY - minY) || 1;

  // Background grid (subtle)
  ctx.strokeStyle = "rgba(255,255,255,.06)";
  ctx.lineWidth = 1;
  for(let i=1;i<=3;i++){
    const y = padT + i * ((cssH - padT - padB)/4);
    ctx.beginPath();
    ctx.moveTo(padL, y);
    ctx.lineTo(cssW - padR, y);
    ctx.stroke();
  }

  // Axes
  ctx.strokeStyle = "rgba(255,255,255,.14)";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(padL, padT);
  ctx.lineTo(padL, cssH - padB);
  ctx.lineTo(cssW - padR, cssH - padB);
  ctx.stroke();

  // Axis labels
  ctx.fillStyle = "rgba(232,234,243,.75)";
  ctx.font = "12px system-ui";
  ctx.fillText("Days", cssW - padR - 34, cssH - 10);

  ctx.save();
  ctx.translate(12, cssH/2);
  ctx.rotate(-Math.PI/2);
  ctx.fillText("Equity ($)", 0, 0);
  ctx.restore();

  // Y-axis tick labels (min / max)
  ctx.fillStyle = "rgba(232,234,243,.65)";
  ctx.font = "11px system-ui";
  const fmt = (n)=> (n<0? "-" : "") + Math.abs(n).toLocaleString(undefined,{maximumFractionDigits:0});
  ctx.fillText(fmt(maxY), padL + 6, padT + 10);
  ctx.fillText(fmt(minY), padL + 6, cssH - padB - 6);

  // Line
  ctx.strokeStyle = "rgba(123,108,255,.95)";
  ctx.lineWidth = 2.5;
  ctx.beginPath();

  const plotW = (cssW - padL - padR);
  const plotH = (cssH - padT - padB);

  points.forEach((p,i)=>{
    const x = padL + (i * (plotW / Math.max(1, points.length-1)));
    const y = (cssH - padB) - ((p.y - minY) / rangeY) * plotH;
    if(i === 0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();

  // Optional: last point dot (no number label)
  const last = points[points.length-1];
  const lx = padL + ((points.length-1) * (plotW / Math.max(1, points.length-1)));
  const ly = (cssH - padB) - ((last.y - minY) / rangeY) * plotH;
  ctx.fillStyle = "rgba(246,197,107,.95)";
  ctx.beginPath();
  ctx.arc(lx, ly, 3, 0, Math.PI*2);
  ctx.fill();12);
}

/* =======================
   BACKUP
   ======================= */
function exportData(){
  const json = JSON.stringify(state, null, 2);
  navigator.clipboard?.writeText(json).then(()=>{
    alert("Export copied to clipboard. Paste it into Notes/Drive.");
  }).catch(()=>{
    // fallback
    prompt("Copy this JSON:", json);
  });
}

function importData(){
  const box = document.getElementById("importBox");
  const txt = box.value.trim();
  if(!txt) return alert("Paste JSON first.");
  try{
    const parsed = JSON.parse(txt);
    state = parsed;
    save();
    alert("Restored.");
  } catch(e){
    alert("Invalid JSON.");
  }
}

function hardResetAll(){
  if(!confirm("Wipe ALL data? This cannot be undone.")) return;
  localStorage.removeItem(KEY);
  state = structuredClone(defaults);
  save();
}

/* =======================
   TABS
   ======================= */
document.querySelectorAll(".tab").forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    document.querySelectorAll(".tabcontent").forEach(c=>c.classList.remove("active"));
    t.classList.add("active");
    document.getElementById(t.dataset.tab).classList.add("active");
  };
});

/* =======================
   RENDER
   ======================= */
function setBar(barId, lvl, xp){
  const need = needForLevel(lvl);
  const pct = Math.max(0, Math.min(100, (xp/need)*100));
  document.getElementById(barId).style.width = pct + "%";
  return need;
}

function renderTrading(){
  // Lock overlay
  const lock = state.locks.tradingHaltedToday;
  document.getElementById("lockOverlay").style.display = lock ? "block" : "none";

  // Fill inputs with today if present
  const d = todayKey();
  const log = state.trading.dailyLogs[d];
  if(log){
    document.getElementById("inPnl").value = log.pnl ?? 0;
    document.getElementById("inTrades").value = log.trades ?? 0;
    document.getElementById("inWins").value = log.wins ?? 0;
    document.getElementById("inLosses").value = log.losses ?? 0;
    document.getElementById("inVios").value = log.vios ?? 0;
    document.getElementById("inDdBuf").value = (log.ddBuf === null || log.ddBuf === undefined) ? "" : log.ddBuf;
  } else {
    // do not wipe user typing if they are in the middle; keep as-is
  }

  const logs = getSortedLogs();
  const stats = computeStats(logs);

  document.getElementById("equityNow").textContent = fmtMoney(stats.equity);
  document.getElementById("statWr").textContent = (stats.wr*100).toFixed(1) + "%";
  document.getElementById("statAvg").textContent = fmtMoney(stats.avg);
  document.getElementById("statMdd").textContent = fmtMoney(stats.mdd);
  document.getElementById("statDays").textContent = stats.days;

  drawChart(stats.equitySeries || []);

  // Table
  const tbody = document.getElementById("logTable");
  tbody.innerHTML = "";
  for(const l of logs.slice().reverse()){
    const ddText = (l.ddBuf === null || l.ddBuf === undefined) ? "" : "$" + fmtMoney(l.ddBuf);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${l.date}</td>
      <td>$${fmtMoney(l.pnl||0)}</td>
      <td>${l.trades||0}</td>
      <td>${l.wins||0}</td>
      <td>${l.losses||0}</td>
      <td>${l.vios||0}</td>
      <td>${ddText}</td>
    `;
    tbody.appendChild(tr);
  }
}

function render(){
  resetIfNewDay();

  const r = computeRank();
  overallRank.textContent = r.rank;

  rankGateText.innerHTML = r.gated
    ? `<span class="warn">GATED</span> ‚Äî target rank ${r.target} requires min pillar level <b>${r.minReq}</b>. Weakest pillar is <b>${r.weakest}</b>.`
    : `<span class="ok">UNLOCKED</span> ‚Äî rank can progress normally.`;

  pillTradeToday.innerHTML = `<strong>Trading Today:</strong> ${state.locks.tradingHaltedToday ? '<span class="warn">HALTED</span>' : '<span class="ok">ALLOWED</span>'}`;
  pillTradeNext.innerHTML = `<strong>Trading Next Day:</strong> ${state.locks.tradingHaltedNext ? '<span class="warn">HALTED</span>' : '<span class="ok">ALLOWED</span>'}`;

  // Trader
  const t = state.pillars.trader;
  lvlTrader.textContent = t.lvl;
  cardLvlTrader.textContent = t.lvl;
  cardXpTrader.textContent = t.xp;
  todayTrader.textContent = t.todayXP;
  const needT = setBar("barTrader", t.lvl, t.xp);
  needTrader.textContent = needT;
  xpTraderText.textContent = `${t.xp} / ${needT} XP`;
  traderLockText.innerHTML = state.locks.tradingHaltedToday
    ? `<span class="warn">Trader XP frozen today</span> (trading halted = no market interaction).`
    : `<span class="ok">Trader XP active</span>.`;

  // Body
  const b = state.pillars.body;
  lvlBody.textContent = b.lvl;
  cardLvlBody.textContent = b.lvl;
  cardXpBody.textContent = b.xp;
  todayBody.textContent = b.todayXP;
  const needB = setBar("barBody", b.lvl, b.xp);
  needBody.textContent = needB;
  xpBodyText.textContent = `${b.xp} / ${needB} XP`;

  // Closer
  const c = state.pillars.closer;
  lvlCloser.textContent = c.lvl;
  cardLvlCloser.textContent = c.lvl;
  cardXpCloser.textContent = c.xp;
  todayCloser.textContent = c.todayXP;
  const needC = setBar("barCloser", c.lvl, c.xp);
  needCloser.textContent = needC;
  xpCloserText.textContent = `${c.xp} / ${needC} XP`;

  // Family
  const f = state.pillars.family;
  lvlFamily.textContent = f.lvl;
  cardLvlFamily.textContent = f.lvl;
  cardXpFamily.textContent = f.xp;
  todayFamily.textContent = f.todayXP;
  const needF = setBar("barFamily", f.lvl, f.xp);
  needFamily.textContent = needF;
  xpFamilyText.textContent = `${f.xp} / ${needF} XP`;

  renderTrading();
}

render();
</script>
</body>
</html>
