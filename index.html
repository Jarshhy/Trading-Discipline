<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jarsh — Life Game (4 Pillars)</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#111826; --muted:#7b8797; --text:#e6edf6;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --accent:#60a5fa;
      --line:#1f2a3a;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:linear-gradient(180deg,#070a0f 0%, #0b0f14 70%);
      color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      letter-spacing:.2px;
    }
    header{
      position:sticky; top:0; z-index:9;
      background:rgba(11,15,20,.85); backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:16px}
    h1{margin:0; font-size:18px}
    .sub{color:var(--muted); font-size:12px; margin-top:4px}
    .grid{display:grid; gap:14px}
    @media(min-width:980px){ .grid.cols2{grid-template-columns: 1.15fr .85fr;} }
    @media(min-width:980px){ .grid.cols3{grid-template-columns: 1fr 1fr 1fr;} }

    .card{
      background:rgba(17,24,38,.85);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .between{display:flex; justify-content:space-between; gap:12px; align-items:center}
    .pill{
      padding:6px 10px; border-radius:999px; font-size:12px;
      border:1px solid var(--line); color:var(--muted);
    }
    .pill.ok{border-color: rgba(34,197,94,.35); color: #a7f3d0}
    .pill.warn{border-color: rgba(245,158,11,.35); color: #fde68a}
    .pill.bad{border-color: rgba(239,68,68,.35); color: #fecaca}
    .pill.accent{border-color: rgba(96,165,250,.35); color: #bfdbfe}

    .kpi{display:grid; grid-template-columns: repeat(4,1fr); gap:10px}
    @media(max-width:720px){ .kpi{grid-template-columns: repeat(2,1fr);} }
    .k{
      background:rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
    }
    .k .t{color:var(--muted); font-size:12px}
    .k .v{font-size:18px; margin-top:4px}

    label{font-size:12px; color:var(--muted)}
    input[type="text"], input[type="number"], input[type="date"], select, textarea{
      width:100%;
      background:rgba(255,255,255,.03);
      color:var(--text);
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px;
      outline:none;
    }
    textarea{min-height:86px; resize:vertical}
    .chk{display:flex; gap:10px; align-items:flex-start; padding:8px 0}
    .chk input{transform: translateY(2px)}
    .small{font-size:12px; color:var(--muted); line-height:1.4}
    .btn{
      appearance:none; border:none; cursor:pointer;
      background: linear-gradient(180deg, rgba(96,165,250,.25), rgba(96,165,250,.12));
      border:1px solid rgba(96,165,250,.35);
      color: #dbeafe;
      padding:10px 12px; border-radius:12px; font-weight:600;
    }
    .btn.secondary{
      background:rgba(255,255,255,.03);
      border:1px solid var(--line);
      color:var(--text);
      font-weight:600;
    }
    .btn.danger{
      background:rgba(239,68,68,.12);
      border:1px solid rgba(239,68,68,.35);
      color:#fee2e2;
    }
    .btn:disabled{opacity:.5; cursor:not-allowed}
    hr{border:none; border-top:1px solid var(--line); margin:12px 0}
    table{width:100%; border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line); padding:8px 6px; font-size:12px; text-align:left}
    th{color:var(--muted); font-weight:600}
    .tag{font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid var(--line); color:var(--muted)}
    .tag.locked{border-color: rgba(245,158,11,.35); color:#fde68a}
    .tag.unlocked{border-color: rgba(34,197,94,.35); color:#a7f3d0}
    .tag.claimed{border-color: rgba(96,165,250,.35); color:#bfdbfe}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="between">
      <div>
        <h1>Life Game — 4 Pillars</h1>
        <div class="sub">Local-only. No accounts. Data stored in your browser (localStorage). GitHub Pages-ready.</div>
      </div>
      <div class="row">
        <span id="statusPill" class="pill">—</span>
        <button class="btn secondary" id="btnExport">Export</button>
        <button class="btn secondary" id="btnImport">Import</button>
        <button class="btn danger" id="btnReset">Reset</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid cols2">
    <section class="card">
      <div class="between">
        <div>
          <div class="row">
            <span class="pill accent">Today</span>
            <span class="pill" id="todayDatePill">—</span>
          </div>
          <div class="small" style="margin-top:8px">
            Rules baked in:
            <span class="mono">Training mandatory</span> ·
            <span class="mono">Protein ≥ 1g/lb</span> ·
            <span class="mono">Sleep ≥ 7h</span> ·
            <span class="mono">Apex hard stop at -200</span> ·
            <span class="mono">+200 is a soft stop (extend only if you play it smarter)</span>.
          </div>
        </div>
        <div class="row">
          <button class="btn" id="btnSave">Save Day</button>
          <button class="btn secondary" id="btnClearToday">Clear Form</button>
        </div>
      </div>

      <hr />

      <div class="grid cols3">
        <!-- FITNESS -->
        <div class="card" style="padding:12px">
          <div class="between">
            <div><strong>Fitness</strong></div>
            <span id="pillFitness" class="pill">—</span>
          </div>
          <div class="chk"><input id="fitTrain" type="checkbox" /> <label for="fitTrain">Trained (mandatory)</label></div>
          <div class="chk"><input id="fitProtein" type="checkbox" /> <label for="fitProtein">Hit protein (≥ 1g/lb)</label></div>
          <div class="chk"><input id="fitSleep" type="checkbox" /> <label for="fitSleep">Sleep ≥ 7 hours (9pm–4am target)</label></div>
          <div class="small">Minimum to pass fitness: all three checked. (You said mandatory training.)</div>
        </div>

        <!-- APEX -->
        <div class="card" style="padding:12px">
          <div class="between">
            <div><strong>Apex</strong></div>
            <span id="pillApex" class="pill">—</span>
          </div>

          <div class="row" style="gap:10px">
            <div style="flex:1">
              <label for="apexTrades">Trades taken (1–6)</label>
              <input id="apexTrades" type="number" min="0" max="20" step="1" value="0"/>
            </div>
            <div style="flex:1">
              <label for="apexMode">Day type</label>
              <select id="apexMode">
                <option value="trade">Trade day</option>
                <option value="no_trade">No-trade day (by plan)</option>
              </select>
            </div>
          </div>

          <hr />

          <div class="chk"><input id="apexHardStopRespected" type="checkbox" /> <label for="apexHardStopRespected">Hard stop respected (stop if -200)</label></div>
          <div class="chk"><input id="apexMaxTradesRespected" type="checkbox" /> <label for="apexMaxTradesRespected">Max trades respected (cap = 6)</label></div>
          <div class="chk"><input id="apexJournal" type="checkbox" /> <label for="apexJournal">Journal done (screenshots + notes)</label></div>

          <hr />

          <div class="chk"><input id="apexSoftStopHit" type="checkbox" /> <label for="apexSoftStopHit">Went past +200 today</label></div>

          <div class="card" style="padding:10px; background:rgba(255,255,255,.02)">
            <div class="between">
              <div><strong class="mono">If you went past +200</strong></div>
              <span class="tag locked" id="tagExtend">Extend: Locked</span>
            </div>
            <div class="small" style="margin-top:8px">
              “Play it smarter” requirements (all must be true):
            </div>
            <div class="chk"><input id="apexExtendTrend" type="checkbox" /> <label for="apexExtendTrend">Trend genuinely continuing (not chop)</label></div>
            <div class="chk"><input id="apexExtendRiskDown" type="checkbox" /> <label for="apexExtendRiskDown">Risk reduced (smaller size / tighter rules)</label></div>
            <div class="chk"><input id="apexExtendNoRevenge" type="checkbox" /> <label for="apexExtendNoRevenge">No revenge behavior (see strikes below)</label></div>
            <div class="chk"><input id="apexExtendMaxTradesDown" type="checkbox" /> <label for="apexExtendMaxTradesDown">Max trades reduced after +200 (≤ 2 more trades)</label></div>
          </div>

          <hr />

          <div class="between">
            <div class="small"><strong>Tilt strikes</strong> (0–3). At 2: mandatory 30-min stop. At 3: done for day.</div>
            <div style="width:120px">
              <input id="apexStrikes" type="number" min="0" max="3" step="1" value="0"/>
            </div>
          </div>

          <div class="chk"><input id="apexRuleBreak" type="checkbox" /> <label for="apexRuleBreak"><span style="color:var(--bad);font-weight:700">Rule break</span> (auto Red Day)</label></div>
        </div>

        <!-- W2 -->
        <div class="card" style="padding:12px">
          <div class="between">
            <div><strong>W2 Job</strong></div>
            <span id="pillW2" class="pill">—</span>
          </div>
          <div class="chk"><input id="w2Dial" type="checkbox" /> <label for="w2Dial">2 hours dedicated dial time</label></div>
          <div class="chk"><input id="w2Learn" type="checkbox" /> <label for="w2Learn">30 minutes learning</label></div>
          <div class="chk"><input id="w2Needle" type="checkbox" /> <label for="w2Needle">One needle-mover shipped (pipeline/closing)</label></div>
          <hr />
          <div class="row" style="gap:10px">
            <div style="flex:1">
              <label for="w2Set">Weekly “set” completed today?</label>
              <select id="w2Set">
                <option value="0">No</option>
                <option value="1">Yes (counts toward 3/week)</option>
              </select>
            </div>
            <div style="flex:1">
              <label for="w2SelfSource">Self-sourced deal action?</label>
              <select id="w2SelfSource">
                <option value="0">No</option>
                <option value="1">Yes</option>
              </select>
            </div>
            <div style="flex:1">
              <label for="w2NoTrial">No-trial push?</label>
              <select id="w2NoTrial">
                <option value="0">No</option>
                <option value="1">Yes</option>
              </select>
            </div>
          </div>
        </div>

        <!-- FAMILY -->
        <div class="card" style="padding:12px">
          <div class="between">
            <div><strong>Family</strong></div>
            <span id="pillFamily" class="pill">—</span>
          </div>
          <div class="chk"><input id="famTalk" type="checkbox" /> <label for="famTalk">30 minutes uninterrupted talking (phone away)</label></div>
          <div class="chk"><input id="famSupport" type="checkbox" /> <label for="famSupport">One support action (help/household/parenting)</label></div>
          <div class="chk"><input id="famPhoneFail" type="checkbox" /> <label for="famPhoneFail">Phone/distraction failure today</label></div>
          <hr />
          <div class="chk"><input id="famRepair" type="checkbox" /> <label for="famRepair">If you were off, you did a same-day repair (apology + reset)</label></div>
          <div class="chk"><input id="famDate" type="checkbox" /> <label for="famDate">Weekly date happened today</label></div>
          <div class="small">Hard fail: you were off + no repair.</div>
        </div>

      </div>

      <hr />

      <div class="row">
        <div style="flex:1">
          <label for="notes">Notes (optional)</label>
          <textarea id="notes" placeholder="What mattered today? What triggered tilt? What worked?"></textarea>
        </div>
      </div>
    </section>

    <aside class="grid" style="gap:14px">
      <section class="card">
        <div class="between">
          <strong>Dashboard</strong>
          <span class="pill accent" id="weekRange">—</span>
        </div>

        <div class="kpi" style="margin-top:10px">
          <div class="k">
            <div class="t">Today</div>
            <div class="v" id="kToday">—</div>
          </div>
          <div class="k">
            <div class="t">Streak</div>
            <div class="v" id="kStreak">0</div>
          </div>
          <div class="k">
            <div class="t">This Week</div>
            <div class="v" id="kWeek">—</div>
          </div>
          <div class="k">
            <div class="t">Red Days (14d)</div>
            <div class="v" id="kRed14">0</div>
          </div>
        </div>

        <hr />

        <div class="between">
          <div class="small">
            <strong>Week rule</strong>: Pass = 4+ Clean days. Gold = 5+ Clean days. Review = ≤3.
          </div>
          <span id="pillWeek" class="pill">—</span>
        </div>

        <hr />

        <div class="small"><strong>Recent days</strong></div>
        <div id="recentTable" style="margin-top:6px"></div>
      </section>

      <section class="card">
        <div class="between">
          <strong>Stability Locks (manual)</strong>
          <span class="pill">No financials</span>
        </div>
        <div class="small" style="margin-top:8px">
          You said “carrots only when stable.” Since this site has no numbers, you manually flip locks when your real-world trend is good.
        </div>
        <hr/>
        <div class="chk"><input id="lockDebtTrend" type="checkbox" /> <label for="lockDebtTrend">Lock 1 — Debt trend improving (4+ good weeks)</label></div>
        <div class="chk"><input id="lockNoChaos" type="checkbox" /> <label for="lockNoChaos">Lock 2 — No chaos (no late payments / no new debt behavior)</label></div>
        <div class="chk"><input id="lockBufferHabit" type="checkbox" /> <label for="lockBufferHabit">Lock 3 — Buffer habit consistent (tax/buffer routine)</label></div>
        <div class="row" style="margin-top:10px">
          <button class="btn secondary" id="btnSaveLocks">Save Locks</button>
        </div>
      </section>

      <section class="card">
        <div class="between">
          <strong>Rewards</strong>
          <span class="pill">Locked / Unlocked / Claimed</span>
        </div>
        <div class="small" style="margin-top:8px">
          Rewards unlock based on <strong>streak + locks</strong>. No money shown. You can edit reward names in Settings.
        </div>
        <hr/>
        <div id="rewardsList"></div>
      </section>

      <section class="card">
        <div class="between">
          <strong>Settings</strong>
          <span class="pill">Edit rules</span>
        </div>
        <div class="row">
          <div style="flex:1">
            <label for="setMaxTrades">Apex max trades/day</label>
            <input id="setMaxTrades" type="number" min="1" max="20" step="1" value="6">
          </div>
          <div style="flex:1">
            <label for="setAfter200ExtraTrades">After +200: allowed extra trades</label>
            <input id="setAfter200ExtraTrades" type="number" min="0" max="10" step="1" value="2">
          </div>
        </div>
        <hr/>
        <label for="setRewardsJson">Rewards JSON (names only; tiers drive locks)</label>
        <textarea id="setRewardsJson" class="mono"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn secondary" id="btnSaveSettings">Save Settings</button>
        </div>
        <div class="small" style="margin-top:10px">
          Tip: Add items from your wish list here (PC setup, carpet cleaning, trip fund, Tesla milestone, house milestone, etc.).
        </div>
      </section>
    </aside>
  </div>

  <div class="card" style="margin-top:14px">
    <div class="between">
      <strong>How to run on GitHub Pages</strong>
      <span class="pill">2 minutes</span>
    </div>
    <ol class="small">
      <li>Create a repo (e.g., <span class="mono">life-game</span>).</li>
      <li>Add this file as <span class="mono">index.html</span> and push.</li>
      <li>Repo → Settings → Pages → Deploy from branch → <span class="mono">main</span> / root.</li>
      <li>Open your Pages URL. Data stays in your browser. Use Export for backups.</li>
    </ol>
  </div>
</main>

<script>
/** =========================
 *  Storage + Defaults
 *  ========================= */
const LS_KEY = "lifeGame_v1";
const LS_LOCKS = "lifeGame_locks_v1";
const LS_SETTINGS = "lifeGame_settings_v1";

function todayISO(){
  const d = new Date();
  const tzOff = d.getTimezoneOffset() * 60000;
  return new Date(d - tzOff).toISOString().slice(0,10);
}
function startOfWeekISO(iso){
  // Monday start
  const d = new Date(iso + "T00:00:00");
  const day = (d.getDay() + 6) % 7; // Mon=0..Sun=6
  d.setDate(d.getDate() - day);
  return d.toISOString().slice(0,10);
}
function addDaysISO(iso, n){
  const d = new Date(iso + "T00:00:00");
  d.setDate(d.getDate() + n);
  return d.toISOString().slice(0,10);
}
function loadJSON(key, fallback){
  try{
    const v = localStorage.getItem(key);
    return v ? JSON.parse(v) : fallback;
  }catch{ return fallback; }
}
function saveJSON(key, obj){
  localStorage.setItem(key, JSON.stringify(obj));
}

const DEFAULT_SETTINGS = {
  apexMaxTrades: 6,
  after200ExtraTrades: 2,
  rewards: [
    // Tier logic:
    // T0 = always
    // T1 = requires Lock1
    // T2 = requires Lock1+Lock2
    // T3 = requires Lock1+Lock2+Lock3 + long streak
    { id:"free_hobby", name:"Tier 0: 60 min guilt-free hobby time", tier:0, streakReq:0 },
    { id:"movie_night", name:"Tier 0: Movie night (phone away)", tier:0, streakReq:0 },

    { id:"otf_band", name:"Tier 1: OTF band (wish list)", tier:1, streakReq:7 },
    { id:"carpet_clean", name:"Tier 1: Carpet cleaning / house reset", tier:1, streakReq:7 },

    { id:"pc_setup", name:"Tier 2: PC setup upgrade (wish list)", tier:2, streakReq:21 },
    { id:"wardrobe", name:"Tier 2: Wardrobe upgrade", tier:2, streakReq:21 },
    { id:"vibration_plate", name:"Tier 2: Vibration plate", tier:2, streakReq:21 },

    { id:"trip_milestone", name:"Tier 3: Trip milestone", tier:3, streakReq:60 },
    { id:"tesla_milestone", name:"Tier 3: Tesla milestone", tier:3, streakReq:60 },
    { id:"house_milestone", name:"Tier 3: House milestone", tier:3, streakReq:90 }
  ]
};

const DEFAULT_LOCKS = { lockDebtTrend:false, lockNoChaos:false, lockBufferHabit:false };

let settings = loadJSON(LS_SETTINGS, DEFAULT_SETTINGS);
let locks = loadJSON(LS_LOCKS, DEFAULT_LOCKS);
let days = loadJSON(LS_KEY, {}); // { "YYYY-MM-DD": dayRecord }

/** =========================
 *  DOM helpers
 *  ========================= */
const $ = (id)=>document.getElementById(id);

function setPill(el, kind, text){
  el.className = "pill" + (kind ? (" " + kind) : "");
  el.textContent = text;
}

function computeDayStatus(rec){
  // Hard fails -> Red Day
  const familyHardFail = (rec.famPhoneFail || rec.familyOff) && !rec.famRepair;
  const apexHardFail = rec.apexRuleBreak || (Number(rec.apexStrikes) >= 3);

  if (apexHardFail || familyHardFail) return "RED";

  // Pillar minimums
  const fitnessOk = rec.fitTrain && rec.fitProtein && rec.fitSleep;

  const apexOk = (rec.apexMode === "no_trade")
    ? (rec.apexJournal) // must still log why you passed
    : (
        rec.apexHardStopRespected &&
        rec.apexMaxTradesRespected &&
        rec.apexJournal &&
        (Number(rec.apexStrikes) <= 2)
      );

  // Soft stop extension rule: only matters if they went past +200.
  let extendOk = true;
  if (rec.apexSoftStopHit){
    extendOk =
      rec.apexExtendTrend &&
      rec.apexExtendRiskDown &&
      rec.apexExtendNoRevenge &&
      rec.apexExtendMaxTradesDown;
    if (!extendOk) return "RED"; // you went past +200 without “playing it smarter”
  }

  const w2Ok = rec.w2Dial && rec.w2Learn && rec.w2Needle;
  const familyOk = rec.famTalk && rec.famSupport;

  if (fitnessOk && apexOk && w2Ok && familyOk) return "CLEAN";
  if (fitnessOk || apexOk || w2Ok || familyOk) return "PARTIAL";
  return "PARTIAL";
}

function computeXP(rec){
  // 25 XP per pillar minimum met (max 100). No bonus farming here; add later if you want.
  const fitnessOk = rec.fitTrain && rec.fitProtein && rec.fitSleep;
  const apexOk = (rec.apexMode === "no_trade")
    ? (rec.apexJournal)
    : (rec.apexHardStopRespected && rec.apexMaxTradesRespected && rec.apexJournal && (Number(rec.apexStrikes) <= 2));
  const w2Ok = rec.w2Dial && rec.w2Learn && rec.w2Needle;
  const familyOk = rec.famTalk && rec.famSupport;

  return (fitnessOk?25:0) + (apexOk?25:0) + (w2Ok?25:0) + (familyOk?25:0);
}

function getStreakUpto(dateISO){
  // streak of consecutive CLEAN ending at dateISO
  let streak = 0;
  let d = dateISO;
  while(true){
    const rec = days[d];
    if (!rec) break;
    if (rec.status !== "CLEAN") break;
    streak++;
    d = addDaysISO(d, -1);
  }
  return streak;
}

function countRedInLastNDays(dateISO, n){
  let c = 0;
  for(let i=0;i<n;i++){
    const d = addDaysISO(dateISO, -i);
    if (days[d]?.status === "RED") c++;
  }
  return c;
}

function weekSummary(weekStartISO){
  let clean=0, partial=0, red=0, xp=0;
  for(let i=0;i<7;i++){
    const d = addDaysISO(weekStartISO, i);
    const rec = days[d];
    if (!rec) continue;
    xp += rec.xp || 0;
    if (rec.status === "CLEAN") clean++;
    else if (rec.status === "RED") red++;
    else partial++;
  }
  let label = "Review";
  let kind = "warn";
  if (clean >= 5){ label = "Gold"; kind = "ok"; }
  else if (clean >= 4){ label = "Pass"; kind = "ok"; }
  return {clean, partial, red, xp, label, kind};
}

function rewardUnlocked(r, streak){
  // Tier lock requirements (manual stability locks)
  const l1 = locks.lockDebtTrend;
  const l2 = locks.lockNoChaos;
  const l3 = locks.lockBufferHabit;

  const tierOk =
    (r.tier === 0) ||
    (r.tier === 1 && l1) ||
    (r.tier === 2 && l1 && l2) ||
    (r.tier === 3 && l1 && l2 && l3);

  const streakOk = (streak >= (r.streakReq || 0));
  return tierOk && streakOk;
}

/** =========================
 *  Form -> Record
 *  ========================= */
function readForm(){
  const apexMax = Number(settings.apexMaxTrades || 6);
  const after200Extra = Number(settings.after200ExtraTrades || 2);
  const trades = Number($("apexTrades").value || 0);

  // auto-check max trades respected if trades <= cap (but user can override)
  const maxTradesRespectedAuto = trades <= apexMax;

  const rec = {
    date: todayISO(),
    // Fitness
    fitTrain: $("fitTrain").checked,
    fitProtein: $("fitProtein").checked,
    fitSleep: $("fitSleep").checked,

    // Apex
    apexMode: $("apexMode").value,
    apexTrades: trades,
    apexHardStopRespected: $("apexHardStopRespected").checked,
    apexMaxTradesRespected: $("apexMaxTradesRespected").checked || maxTradesRespectedAuto,
    apexJournal: $("apexJournal").checked,
    apexSoftStopHit: $("apexSoftStopHit").checked,
    apexExtendTrend: $("apexExtendTrend").checked,
    apexExtendRiskDown: $("apexExtendRiskDown").checked,
    apexExtendNoRevenge: $("apexExtendNoRevenge").checked,
    apexExtendMaxTradesDown: $("apexExtendMaxTradesDown").checked,
    apexStrikes: Number($("apexStrikes").value || 0),
    apexRuleBreak: $("apexRuleBreak").checked,

    // W2
    w2Dial: $("w2Dial").checked,
    w2Learn: $("w2Learn").checked,
    w2Needle: $("w2Needle").checked,
    w2Set: Number($("w2Set").value || 0),
    w2SelfSource: Number($("w2SelfSource").value || 0),
    w2NoTrial: Number($("w2NoTrial").value || 0),

    // Family
    famTalk: $("famTalk").checked,
    famSupport: $("famSupport").checked,
    famPhoneFail: $("famPhoneFail").checked,
    famRepair: $("famRepair").checked,
    famDate: $("famDate").checked,
    // Derived “familyOff” if phone fail checked (simple proxy)
    familyOff: $("famPhoneFail").checked,

    notes: $("notes").value || "",
    meta: {
      apexMaxTrades: apexMax,
      after200ExtraTrades: after200Extra
    }
  };

  // Extension rule guidance tag: if past +200, enforce max extra trades
  if (rec.apexSoftStopHit){
    // require max trades reduced after +200: trades must be <= (apexMax + after200Extra) AND user confirms reduction
    const allowedTotal = apexMax + after200Extra;
    // If they went past +200 and traded beyond allowedTotal, that's a rule break.
    if (rec.apexTrades > allowedTotal){
      rec.apexRuleBreak = true;
    }
  }

  rec.status = computeDayStatus(rec);
  rec.xp = computeXP(rec);
  return rec;
}

function loadFormForDate(iso){
  const rec = days[iso];
  if (!rec) return;

  $("fitTrain").checked = !!rec.fitTrain;
  $("fitProtein").checked = !!rec.fitProtein;
  $("fitSleep").checked = !!rec.fitSleep;

  $("apexMode").value = rec.apexMode || "trade";
  $("apexTrades").value = rec.apexTrades ?? 0;
  $("apexHardStopRespected").checked = !!rec.apexHardStopRespected;
  $("apexMaxTradesRespected").checked = !!rec.apexMaxTradesRespected;
  $("apexJournal").checked = !!rec.apexJournal;
  $("apexSoftStopHit").checked = !!rec.apexSoftStopHit;
  $("apexExtendTrend").checked = !!rec.apexExtendTrend;
  $("apexExtendRiskDown").checked = !!rec.apexExtendRiskDown;
  $("apexExtendNoRevenge").checked = !!rec.apexExtendNoRevenge;
  $("apexExtendMaxTradesDown").checked = !!rec.apexExtendMaxTradesDown;
  $("apexStrikes").value = rec.apexStrikes ?? 0;
  $("apexRuleBreak").checked = !!rec.apexRuleBreak;

  $("w2Dial").checked = !!rec.w2Dial;
  $("w2Learn").checked = !!rec.w2Learn;
  $("w2Needle").checked = !!rec.w2Needle;
  $("w2Set").value = rec.w2Set ?? 0;
  $("w2SelfSource").value = rec.w2SelfSource ?? 0;
  $("w2NoTrial").value = rec.w2NoTrial ?? 0;

  $("famTalk").checked = !!rec.famTalk;
  $("famSupport").checked = !!rec.famSupport;
  $("famPhoneFail").checked = !!rec.famPhoneFail;
  $("famRepair").checked = !!rec.famRepair;
  $("famDate").checked = !!rec.famDate;

  $("notes").value = rec.notes || "";
}

function clearForm(){
  [
    "fitTrain","fitProtein","fitSleep",
    "apexHardStopRespected","apexMaxTradesRespected","apexJournal",
    "apexSoftStopHit","apexExtendTrend","apexExtendRiskDown","apexExtendNoRevenge","apexExtendMaxTradesDown",
    "apexRuleBreak",
    "w2Dial","w2Learn","w2Needle",
    "famTalk","famSupport","famPhoneFail","famRepair","famDate"
  ].forEach(id => $(id).checked = false);

  $("apexTrades").value = 0;
  $("apexMode").value = "trade";
  $("apexStrikes").value = 0;

  $("w2Set").value = "0";
  $("w2SelfSource").value = "0";
  $("w2NoTrial").value = "0";

  $("notes").value = "";
}

/** =========================
 *  UI rendering
 *  ========================= */
function renderPillStates(rec){
  const map = { CLEAN:["ok","CLEAN"], PARTIAL:["warn","PARTIAL"], RED:["bad","RED"] };
  const [k, t] = map[rec.status] || ["","—"];
  setPill($("statusPill"), k, t);
  $("kToday").textContent = t;

  // Fitness
  const fitnessOk = rec.fitTrain && rec.fitProtein && rec.fitSleep;
  setPill($("pillFitness"), fitnessOk ? "ok" : "warn", fitnessOk ? "PASS" : "MISS");

  // Apex
  const apexOk = (rec.apexMode === "no_trade")
    ? (rec.apexJournal && rec.status !== "RED")
    : (rec.apexHardStopRespected && rec.apexMaxTradesRespected && rec.apexJournal && Number(rec.apexStrikes) <= 2 && rec.status !== "RED");
  setPill($("pillApex"), (rec.status==="RED") ? "bad" : (apexOk ? "ok" : "warn"), (rec.status==="RED") ? "FAIL" : (apexOk ? "PASS" : "MISS"));

  // W2
  const w2Ok = rec.w2Dial && rec.w2Learn && rec.w2Needle;
  setPill($("pillW2"), w2Ok ? "ok" : "warn", w2Ok ? "PASS" : "MISS");

  // Family
  const familyOk = rec.famTalk && rec.famSupport && !( (rec.famPhoneFail||rec.familyOff) && !rec.famRepair );
  setPill($("pillFamily"), (rec.status==="RED" && ((rec.famPhoneFail||rec.familyOff) && !rec.famRepair)) ? "bad" : (familyOk ? "ok" : "warn"),
    (rec.status==="RED" && ((rec.famPhoneFail||rec.familyOff) && !rec.famRepair)) ? "FAIL" : (familyOk ? "PASS" : "MISS"));

  // Extend tag
  const extendLocked = rec.apexSoftStopHit ? !(rec.apexExtendTrend && rec.apexExtendRiskDown && rec.apexExtendNoRevenge && rec.apexExtendMaxTradesDown) : true;
  const extendOk = rec.apexSoftStopHit ? !extendLocked : false;
  const tag = $("tagExtend");
  if (!rec.apexSoftStopHit){
    tag.className = "tag locked";
    tag.textContent = "Extend: Locked";
  } else if (extendOk){
    tag.className = "tag unlocked";
    tag.textContent = "Extend: OK";
  } else {
    tag.className = "tag locked";
    tag.textContent = "Extend: Not Met";
  }
}

function renderDashboard(){
  const t = todayISO();
  $("todayDatePill").textContent = t;

  // streak & red count
  const streak = getStreakUpto(t);
  $("kStreak").textContent = String(streak);
  $("kRed14").textContent = String(countRedInLastNDays(t, 14));

  // week summary
  const ws = startOfWeekISO(t);
  const we = addDaysISO(ws, 6);
  $("weekRange").textContent = `${ws} → ${we}`;
  const sum = weekSummary(ws);
  $("kWeek").textContent = `${sum.clean} clean`;
  setPill($("pillWeek"), sum.kind, sum.label);

  // recent table (last 10)
  let rows = [];
  for(let i=0;i<10;i++){
    const d = addDaysISO(t, -i);
    const rec = days[d];
    if (!rec) continue;
    const s = rec.status;
    const tagClass = (s==="CLEAN")?"unlocked":(s==="RED")?"locked":"locked";
    rows.push(`<tr>
      <td class="mono">${d}</td>
      <td><span class="tag ${s==="CLEAN"?"unlocked":(s==="RED"?"locked":"locked")}">${s}</span></td>
      <td>${rec.xp||0}</td>
      <td><button class="btn secondary" data-load="${d}" style="padding:6px 10px;border-radius:10px">Load</button></td>
    </tr>`);
  }
  $("recentTable").innerHTML = `
    <table>
      <thead><tr><th>Date</th><th>Status</th><th>XP</th><th></th></tr></thead>
      <tbody>${rows.join("") || `<tr><td colspan="4" class="small">No saved days yet.</td></tr>`}</tbody>
    </table>
  `;

  // attach load handlers
  document.querySelectorAll("button[data-load]").forEach(btn=>{
    btn.onclick = ()=>{
      const d = btn.getAttribute("data-load");
      loadFormForDate(d);
      // render pills for loaded record
      renderPillStates(days[d]);
      window.scrollTo({top:0,behavior:"smooth"});
    };
  });

  renderRewards();
}

function renderRewards(){
  const t = todayISO();
  const streak = getStreakUpto(t);
  const claimed = loadJSON("lifeGame_claimed_v1", {}); // { rewardId: {claimedOn:"YYYY-MM-DD"} }

  const list = settings.rewards || [];
  let html = "";

  list.forEach(r=>{
    const unlocked = rewardUnlocked(r, streak);
    const isClaimed = !!claimed[r.id];
    const statusTag = isClaimed ? `<span class="tag claimed">CLAIMED</span>`
      : unlocked ? `<span class="tag unlocked">UNLOCKED</span>`
      : `<span class="tag locked">LOCKED</span>`;

    const btn = isClaimed
      ? `<button class="btn secondary" data-unclaim="${r.id}" style="padding:6px 10px">Unclaim</button>`
      : unlocked
        ? `<button class="btn" data-claim="${r.id}" style="padding:6px 10px">Claim</button>`
        : `<button class="btn secondary" disabled style="padding:6px 10px">Locked</button>`;

    const reqBits = [];
    if (r.streakReq) reqBits.push(`streak ≥ ${r.streakReq}`);
    if (r.tier===1) reqBits.push("Lock1");
    if (r.tier===2) reqBits.push("Lock1+Lock2");
    if (r.tier===3) reqBits.push("Lock1+Lock2+Lock3");

    html += `
      <div class="card" style="padding:10px; margin-bottom:10px; background:rgba(255,255,255,.02)">
        <div class="between">
          <div>
            <div style="font-weight:700">${escapeHtml(r.name)}</div>
            <div class="small">Tier ${r.tier} • Requirements: ${reqBits.join(" + ") || "none"}</div>
          </div>
          <div class="row">
            ${statusTag}
            ${btn}
          </div>
        </div>
      </div>
    `;
  });

  $("rewardsList").innerHTML = html || `<div class="small">No rewards configured.</div>`;

  // claim/unclaim handlers
  document.querySelectorAll("button[data-claim]").forEach(b=>{
    b.onclick = ()=>{
      const id = b.getAttribute("data-claim");
      const claimedNow = loadJSON("lifeGame_claimed_v1", {});
      claimedNow[id] = { claimedOn: todayISO() };
      saveJSON("lifeGame_claimed_v1", claimedNow);
      renderRewards();
    };
  });
  document.querySelectorAll("button[data-unclaim]").forEach(b=>{
    b.onclick = ()=>{
      const id = b.getAttribute("data-unclaim");
      const claimedNow = loadJSON("lifeGame_claimed_v1", {});
      delete claimedNow[id];
      saveJSON("lifeGame_claimed_v1", claimedNow);
      renderRewards();
    };
  });
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/** =========================
 *  Locks + Settings UI
 *  ========================= */
function loadLocksUI(){
  $("lockDebtTrend").checked = !!locks.lockDebtTrend;
  $("lockNoChaos").checked = !!locks.lockNoChaos;
  $("lockBufferHabit").checked = !!locks.lockBufferHabit;
}
function loadSettingsUI(){
  $("setMaxTrades").value = settings.apexMaxTrades ?? 6;
  $("setAfter200ExtraTrades").value = settings.after200ExtraTrades ?? 2;
  $("setRewardsJson").value = JSON.stringify(settings.rewards || DEFAULT_SETTINGS.rewards, null, 2);
}

/** =========================
 *  Events
 *  ========================= */
function bindEvents(){
  $("btnSave").onclick = ()=>{
    const rec = readForm();
    days[rec.date] = rec;
    saveJSON(LS_KEY, days);
    renderPillStates(rec);
    renderDashboard();
  };

  $("btnClearToday").onclick = ()=>{
    clearForm();
    // show neutral pills
    const neutral = {status:"PARTIAL", fitTrain:false, fitProtein:false, fitSleep:false, apexMode:"trade", apexHardStopRespected:false, apexMaxTradesRespected:false, apexJournal:false, apexStrikes:0,
      w2Dial:false,w2Learn:false,w2Needle:false, famTalk:false,famSupport:false,famPhoneFail:false,famRepair:false,familyOff:false, apexSoftStopHit:false,
      apexExtendTrend:false,apexExtendRiskDown:false,apexExtendNoRevenge:false,apexExtendMaxTradesDown:false, apexRuleBreak:false
    };
    renderPillStates(neutral);
  };

  $("btnSaveLocks").onclick = ()=>{
    locks = {
      lockDebtTrend: $("lockDebtTrend").checked,
      lockNoChaos: $("lockNoChaos").checked,
      lockBufferHabit: $("lockBufferHabit").checked
    };
    saveJSON(LS_LOCKS, locks);
    renderDashboard();
  };

  $("btnSaveSettings").onclick = ()=>{
    const maxTrades = Number($("setMaxTrades").value || 6);
    const after200 = Number($("setAfter200ExtraTrades").value || 2);
    let rewards;
    try{
      rewards = JSON.parse($("setRewardsJson").value || "[]");
      if (!Array.isArray(rewards)) throw new Error("Rewards must be an array");
      // minimal validation
      rewards.forEach(r=>{
        if (!r.id || !r.name) throw new Error("Each reward needs id + name");
        if (typeof r.tier !== "number") r.tier = 0;
        if (typeof r.streakReq !== "number") r.streakReq = 0;
      });
    }catch(e){
      alert("Settings not saved. Rewards JSON invalid:\n" + e.message);
      return;
    }
    settings = { apexMaxTrades:maxTrades, after200ExtraTrades:after200, rewards };
    saveJSON(LS_SETTINGS, settings);
    alert("Saved.");
    renderDashboard();
  };

  $("btnExport").onclick = ()=>{
    const payload = {
      version: 1,
      exportedAt: new Date().toISOString(),
      days,
      locks,
      settings,
      claimed: loadJSON("lifeGame_claimed_v1", {})
    };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `life-game-export-${todayISO()}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  };

  $("btnImport").onclick = ()=>{
    const inp = document.createElement("input");
    inp.type = "file";
    inp.accept = "application/json";
    inp.onchange = ()=>{
      const f = inp.files?.[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const data = JSON.parse(reader.result);
          if (!data || data.version !== 1) throw new Error("Wrong file/version");
          days = data.days || {};
          locks = data.locks || DEFAULT_LOCKS;
          settings = data.settings || DEFAULT_SETTINGS;
          saveJSON(LS_KEY, days);
          saveJSON(LS_LOCKS, locks);
          saveJSON(LS_SETTINGS, settings);
          saveJSON("lifeGame_claimed_v1", data.claimed || {});
          loadLocksUI();
          loadSettingsUI();
          hydrateToday();
          renderDashboard();
          alert("Imported.");
        }catch(e){
          alert("Import failed:\n" + e.message);
        }
      };
      reader.readAsText(f);
    };
    inp.click();
  };

  $("btnReset").onclick = ()=>{
    const ok = confirm("Reset everything? This wipes all local data for this site.");
    if (!ok) return;
    localStorage.removeItem(LS_KEY);
    localStorage.removeItem(LS_LOCKS);
    localStorage.removeItem(LS_SETTINGS);
    localStorage.removeItem("lifeGame_claimed_v1");
    days = {};
    locks = DEFAULT_LOCKS;
    settings = DEFAULT_SETTINGS;
    clearForm();
    loadLocksUI();
    loadSettingsUI();
    renderDashboard();
    alert("Reset done.");
  };

  // helpful auto-behavior: if trades entered, try to keep max-trades respected accurate
  $("apexTrades").addEventListener("input", ()=>{
    const trades = Number($("apexTrades").value || 0);
    const apexMax = Number(settings.apexMaxTrades || 6);
    if (trades <= apexMax) $("apexMaxTradesRespected").checked = true;
  });

  // If no-trade day, disable trade-constraint checkboxes that don't apply (but keep journal)
  $("apexMode").addEventListener("change", ()=>{
    const isNoTrade = $("apexMode").value === "no_trade";
    ["apexHardStopRespected","apexMaxTradesRespected","apexSoftStopHit","apexExtendTrend","apexExtendRiskDown","apexExtendNoRevenge","apexExtendMaxTradesDown"]
      .forEach(id => $(id).disabled = isNoTrade);
    if (isNoTrade){
      $("apexTrades").value = 0;
      $("apexHardStopRespected").checked = false;
      $("apexMaxTradesRespected").checked = false;
      $("apexSoftStopHit").checked = false;
      $("apexExtendTrend").checked = false;
      $("apexExtendRiskDown").checked = false;
      $("apexExtendNoRevenge").checked = false;
      $("apexExtendMaxTradesDown").checked = false;
    }
  });
}

function hydrateToday(){
  const t = todayISO();
  // load last saved today if exists
  if (days[t]) loadFormForDate(t);

  // render pills based on current form or saved
  const rec = days[t] || readForm();
  renderPillStates(rec);
}

(function init(){
  // ensure settings keys exist
  settings = Object.assign({}, DEFAULT_SETTINGS, settings);
  if (!settings.rewards) settings.rewards = DEFAULT_SETTINGS.rewards;

  // UI seed
  loadLocksUI();
  loadSettingsUI();
  bindEvents();
  hydrateToday();
  renderDashboard();
})();
</script>
</body>
</html>

</script>
</body>
</html>
